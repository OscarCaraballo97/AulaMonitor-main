<ion-header>
  <ion-toolbar color="primary" class="dark:bg-kwd-darker">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/reservations/my-list"></ion-back-button>
    </ion-buttons>
    <ion-title class="dark:text-kwd-light">{{ pageTitle }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding bg-gray-100 dark:bg-kwd-dark">
  <div class="max-w-2xl mx-auto">
    <div *ngIf="isLoadingInitialData && !isEditMode" class="py-16 text-center">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="mt-4 text-gray-500 dark:text-gray-400">Cargando datos necesarios...</p>
    </div>

    <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()" *ngIf="reservationForm && !isLoadingInitialData" class="space-y-4 bg-white dark:bg-kwd-darker p-6 rounded-lg shadow-md">
      <ion-item lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
        <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Aula <span class="text-red-500">*</span></ion-label>
        <ion-select #classroomSelectControl formControlName="classroomId" interface="popover" placeholder="Selecciona un aula"
                    class="text-gray-900 dark:text-kwd-light"
                    [ngClass]="{'ion-invalid ion-touched': reservationForm.get('classroomId')?.invalid && reservationForm.get('classroomId')?.touched}">
          <ion-select-option *ngFor="let classroom of classrooms" [value]="classroom.id">
            {{ classroom.name }}
            <span *ngIf="classroom.building"> ({{ classroom.building.name }})</span>
          </ion-select-option>
        </ion-select>
      </ion-item>
      <div *ngIf="reservationForm.get('classroomId')?.invalid && reservationForm.get('classroomId')?.touched" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small *ngIf="reservationForm.get('classroomId')?.errors?.['required']">El aula es requerida.</small>
      </div>

      <ion-item *ngIf="userRole === RolEnum.COORDINADOR && !isEditMode" lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
        <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Reservar para Estudiante <span class="text-red-500">*</span></ion-label>
        <ion-select formControlName="userId" interface="popover" placeholder="Seleccionar Estudiante"
                    class="text-gray-900 dark:text-kwd-light"
                    [ngClass]="{'ion-invalid ion-touched': reservationForm.get('userId')?.invalid && reservationForm.get('userId')?.touched}">
          <ion-select-option *ngFor="let student of studentUsers" [value]="student.id">
            {{ student.name }} ({{ student.email }})
          </ion-select-option>
        </ion-select>
      </ion-item>
      <div *ngIf="userRole === RolEnum.COORDINADOR && !isEditMode && reservationForm.get('userId')?.invalid && reservationForm.get('userId')?.touched" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small *ngIf="reservationForm.get('userId')?.errors?.['required']">Es requerido seleccionar un estudiante.</small>
      </div>


      <ion-item lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
        <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Fecha <span class="text-red-500">*</span></ion-label>
        <ion-select formControlName="reservationDateControl" interface="popover" placeholder="Selecciona una fecha"
                    class="text-gray-900 dark:text-kwd-light"
                    [ngClass]="{'ion-invalid ion-touched': reservationForm.get('reservationDateControl')?.invalid && reservationForm.get('reservationDateControl')?.touched}">
          <ion-select-option *ngFor="let dateOpt of selectableDates" [value]="dateOpt.value">
            {{ dateOpt.display }}
          </ion-select-option>
        </ion-select>
      </ion-item>
      <div *ngIf="selectableDates.length === 0 && !isLoadingInitialData" class="text-xs text-orange-600 dark:text-kwd-orange mt-1 px-4">
          <small>No hay fechas disponibles para seleccionar en este momento.</small>
      </div>
      <div *ngIf="reservationForm.get('reservationDateControl')?.invalid && reservationForm.get('reservationDateControl')?.touched" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small *ngIf="reservationForm.get('reservationDateControl')?.errors?.['required']">La fecha es requerida.</small>
      </div>

      <div *ngIf="reservationForm.get('classroomId')?.value && reservationForm.get('reservationDateControl')?.value">
        <h3 class="font-medium text-gray-700 dark:text-gray-300 mt-4 mb-2 px-4">Horas de Inicio Disponibles ({{ datePipe.transform(selectedDateForTimeSlots, 'EEEE, d MMMM', undefined, 'es-CO') }}):</h3>
        <div *ngIf="isLoadingTimes" class="text-center py-4">
          <ion-spinner name="dots" color="primary"></ion-spinner>
          <p class="text-gray-500 dark:text-gray-400">Cargando horarios...</p>
        </div>
        <div *ngIf="!isLoadingTimes && availableStartTimes.length === 0" class="p-4 bg-gray-100 dark:bg-kwd-dark rounded text-center text-gray-500 dark:text-gray-400">
          No hay horarios disponibles para la fecha y aula seleccionadas.
        </div>
        <div *ngIf="!isLoadingTimes && availableStartTimes.length > 0" class="grid grid-cols-3 sm:grid-cols-4 gap-2 p-2">
          <ion-button
            *ngFor="let slot of availableStartTimes"
            fill="outline"
            size="small"
            [color]="reservationForm.get('startTime')?.value === slot.value ? 'primary' : 'medium'"
            (click)="onStartTimeSelected(slot.value)"
            class="dark:text-kwd-light dark:border-gray-600"
            [class.selected-time-slot]="reservationForm.get('startTime')?.value === slot.value">
            {{ slot.display }}
          </ion-button>
        </div>
      </div>
      <div *ngIf="reservationForm.get('startTime')?.invalid && reservationForm.get('startTime')?.touched && !isLoadingTimes && (availableStartTimes.length > 0 || isEditMode)" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small *ngIf="reservationForm.get('startTime')?.errors?.['required']">La hora de inicio es requerida.</small>
      </div>

      <ion-item *ngIf="reservationForm.get('endTime')?.value" lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light">
        <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Hora de Finalización</ion-label>
        <ion-input
          [value]="datePipe.transform(reservationForm.get('endTime')?.value, 'HH:mm', undefined, 'es-CO')"
          readonly
          class="text-gray-900 dark:text-kwd-light">
        </ion-input>
      </ion-item>
      <div *ngIf="reservationForm.hasError('invalidDateTimeOrder') && reservationForm.get('endTime')?.touched" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small>La hora de finalización debe ser posterior a la hora de inicio.</small>
      </div>

      <ion-item lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
        <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Propósito</ion-label>
        <ion-textarea formControlName="purpose" rows="3" placeholder="Ej: Clase de cálculo, Tutoría de física..."
                      class="text-gray-900 dark:text-kwd-light"></ion-textarea>
      </ion-item>
      <div *ngIf="reservationForm.get('purpose')?.invalid && reservationForm.get('purpose')?.touched" class="text-xs text-red-600 dark:text-kwd-red mt-1 px-4">
        <small *ngIf="reservationForm.get('purpose')?.errors?.['maxLength']">El propósito no debe exceder los 255 caracteres.</small>
      </div>

      <div *ngIf="userRole === RolEnum.ADMIN" class="space-y-4 mt-4">
        <ion-item *ngIf="isEditMode && reservationOwnerName" lines="none" class="rounded-md bg-gray-100 dark:bg-kwd-dark-light">
          <ion-label position="stacked" class="text-gray-600 dark:text-gray-400">Reserva a nombre de:</ion-label>
          <ion-input [value]="reservationOwnerName" readonly class="text-gray-800 dark:text-kwd-light"></ion-input>
        </ion-item>
        <ion-item lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
          <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">
            ID de Usuario
            <span *ngIf="!isEditMode">(Opcional, si se deja vacío se asigna al Admin actual)</span>
          </ion-label>
          <ion-input formControlName="userId" type="text"
                     placeholder="{{ !isEditMode ? 'ID de usuario o vacío' : '' }}"
                     class="text-gray-900 dark:text-kwd-light"
                     [readonly]="isEditMode && userRole !== RolEnum.ADMIN"> </ion-input>
        </ion-item>

        <ion-item *ngIf="isEditMode" lines="none" class="rounded-md shadow-sm bg-gray-50 dark:bg-kwd-dark dark:text-kwd-light focus-within:ring-2 focus-within:ring-inset focus-within:ring-kwd-blue-DEFAULT">
          <ion-label position="stacked" class="text-gray-700 dark:text-gray-300">Estado</ion-label>
          <ion-select formControlName="status" interface="popover" class="text-gray-900 dark:text-kwd-light">
            <ion-select-option *ngFor="let statusOpt of availableStatuses" [value]="statusOpt">
              {{ statusOpt.replace('_', ' ') | titlecase }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="flex flex-col sm:flex-row justify-end pt-6 space-y-3 sm:space-y-0 sm:space-x-3">
        <ion-button type="button" fill="outline" (click)="cancel()" color="medium" class="dark:text-gray-300 dark:border-gray-600">
          Cancelar
        </ion-button>
        <ion-button type="submit" [disabled]="reservationForm.invalid || isLoading" color="primary" class="dark:text-white">
          <ion-spinner *ngIf="isLoading" name="dots" class="mr-2"></ion-spinner>
          {{ isEditMode ? 'Actualizar' : 'Crear' }} Reserva
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>
